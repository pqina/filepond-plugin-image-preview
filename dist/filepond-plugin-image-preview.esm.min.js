/*!
 * FilePondPluginImagePreview 4.2.1
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */

/* eslint-disable */

const e={type:"spring",stiffness:.5,damping:.45,mass:10},t=(e,t)=>({x:e,y:t}),a=(e,a)=>t(e.x-a.x,e.y-a.y),i=(e,t)=>Math.sqrt(((e,t)=>((e,t)=>e.x*t.x+e.y*t.y)(a(e,t),a(e,t)))(e,t)),r=(e,a)=>{const i=e,r=a,o=1.5707963267948966-a,n=Math.sin(1.5707963267948966),s=Math.sin(r),c=Math.sin(o),l=Math.cos(o),h=i/n;return t(l*(h*s),l*(h*c))},o=(e,a,o,n)=>{const s=n.x>.5?1-n.x:n.x,c=n.y>.5?1-n.y:n.y,l=2*s*e.width,h=2*c*e.height,d=((e,a)=>{const o=e.width,n=e.height,s=r(o,a),c=r(n,a),l=t(e.x+Math.abs(s.x),e.y-Math.abs(s.y)),h=t(e.x+e.width+Math.abs(c.y),e.y+Math.abs(c.x)),d=t(e.x-Math.abs(c.y),e.y+e.height-Math.abs(c.x));return{width:i(l,h),height:i(l,d)}})(a,o);return Math.max(d.width/l,d.height/h)},n=t=>t.utils.createView({name:"image-clip",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["width","height","opacity"],animations:{opacity:{type:"tween",duration:250}}},create:({root:a,props:i})=>{a.ref.image=a.appendChildView(a.createChildView((t=>t.utils.createView({name:"image-canvas-wrapper",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["originX","originY","translateX","translateY","scaleX","scaleY","rotateZ"],animations:{originX:e,originY:e,scaleX:e,scaleY:e,translateX:e,translateY:e,rotateZ:e}},create:({root:e,props:a})=>{a.width=a.image.width,a.height=a.image.height,e.ref.bitmap=e.appendChildView(e.createChildView((e=>e.utils.createView({name:"image-bitmap",ignoreRect:!0,mixins:{styles:["scaleX","scaleY"]},create:({root:e,props:t})=>{e.appendChild(t.image)}}))(t),{image:a.image}))},write:({root:e,props:t})=>{const{flip:a}=t.crop,{bitmap:i}=e.ref;i.scaleX=a.horizontal?-1:1,i.scaleY=a.vertical?-1:1}}))(t),Object.assign({},i)));const r=a.query("GET_IMAGE_PREVIEW_TRANSPARENCY_INDICATOR");null!==r&&(a.element.dataset.transparencyIndicator="grid"===r?r:"color")},write:({root:e,props:t,shouldOptimize:a})=>{const{crop:i,width:r,height:n}=t;e.ref.image.crop=i;const s={x:0,y:0,width:r,height:n,center:{x:.5*r,y:.5*n}},c={width:e.ref.image.width,height:e.ref.image.height},l={x:i.center.x*c.width,y:i.center.y*c.height},h={x:s.center.x-c.width*i.center.x,y:s.center.y-c.height*i.center.y},d=2*Math.PI+i.rotation%(2*Math.PI),g=i.aspectRatio||c.height/c.width,p=o(c,((e,t)=>{let a=e.width,i=a*t;return i>e.height&&(a=(i=e.height)/t),{x:.5*(e.width-a),y:.5*(e.height-i),width:a,height:i}})(s,g),d,i.center),E=i.zoom*p,m=e.ref.image;if(a)return m.originX=null,m.originY=null,m.translateX=null,m.translateY=null,m.rotateZ=null,m.scaleX=null,void(m.scaleY=null);m.originX=l.x,m.originY=l.y,m.translateX=h.x,m.translateY=h.y,m.rotateZ=d,m.scaleX=E,m.scaleY=E}});let s='<svg width="500" height="200" viewBox="0 0 500 200" preserveAspectRatio="none">\n    <defs>\n        <radialGradient id="gradient-__UID__" cx=".5" cy="1.25" r="1.15">\n            <stop offset=\'50%\' stop-color=\'#000000\'/>\n            <stop offset=\'56%\' stop-color=\'#0a0a0a\'/>\n            <stop offset=\'63%\' stop-color=\'#262626\'/>\n            <stop offset=\'69%\' stop-color=\'#4f4f4f\'/>\n            <stop offset=\'75%\' stop-color=\'#808080\'/>\n            <stop offset=\'81%\' stop-color=\'#b1b1b1\'/>\n            <stop offset=\'88%\' stop-color=\'#dadada\'/>\n            <stop offset=\'94%\' stop-color=\'#f6f6f6\'/>\n            <stop offset=\'100%\' stop-color=\'#ffffff\'/>\n        </radialGradient>\n        <mask id="mask-__UID__">\n            <rect x="0" y="0" width="500" height="200" fill="url(#gradient-__UID__)"></rect>\n        </mask>\n    </defs>\n    <rect x="0" width="500" height="200" fill="currentColor" mask="url(#mask-__UID__)"></rect>\n</svg>',c=!1,l=0;const h=function(){self.onmessage=(e=>{createImageBitmap(e.data.message.file).then(t=>{self.postMessage({id:e.data.id,message:t},[t])})})},d=function(){self.onmessage=(e=>{const t=e.data.message.imageData,a=e.data.message.colorMatrix,i=t.data,r=i.length,o=a[0],n=a[1],s=a[2],c=a[3],l=a[4],h=a[5],d=a[6],g=a[7],p=a[8],E=a[9],m=a[10],_=a[11],I=a[12],f=a[13],u=a[14],w=a[15],y=a[16],M=a[17],T=a[18],A=a[19];let R=0,D=0,v=0,P=0,G=0;for(;R<r;R+=4)D=i[R]/255,v=i[R+1]/255,P=i[R+2]/255,G=i[R+3]/255,i[R]=Math.max(0,Math.min(255*(D*o+v*n+P*s+G*c+l),255)),i[R+1]=Math.max(0,Math.min(255*(D*h+v*d+P*g+G*p+E),255)),i[R+2]=Math.max(0,Math.min(255*(D*m+v*_+P*I+G*f+u),255)),i[R+3]=Math.max(0,Math.min(255*(D*w+v*y+P*M+G*T+A),255));self.postMessage({id:e.data.id,message:t},[t.data.buffer])})},g={1:()=>[1,0,0,1,0,0],2:e=>[-1,0,0,1,e,0],3:(e,t)=>[-1,0,0,-1,e,t],4:(e,t)=>[1,0,0,-1,0,t],5:()=>[0,1,1,0,0,0],6:(e,t)=>[0,1,-1,0,t,0],7:(e,t)=>[0,-1,-1,0,t,e],8:e=>[0,-1,1,0,0,e]},p=(e,t,a,i)=>{t=Math.round(t),a=Math.round(a);const r=document.createElement("canvas");r.width=t,r.height=a;const o=r.getContext("2d");return i>=5&&i<=8&&([t,a]=[a,t]),((e,t,a,i)=>{-1!==i&&e.transform.apply(e,g[i](t,a))})(o,t,a,i),o.drawImage(e,0,0,t,a),r},E=e=>/^image/.test(e.type)&&!/svg/.test(e.type),m=e=>{const t=Math.min(10/e.width,10/e.height),a=document.createElement("canvas"),i=a.getContext("2d"),r=a.width=Math.ceil(e.width*t),o=a.height=Math.ceil(e.height*t);i.drawImage(e,0,0,r,o);let n=null;try{n=i.getImageData(0,0,r,o).data}catch(e){return null}const s=n.length;let c=0,l=0,h=0,d=0;for(;d<s;d+=4)c+=n[d]*n[d],l+=n[d+1]*n[d+1],h+=n[d+2]*n[d+2];return{r:c=_(c,s),g:l=_(l,s),b:h=_(h,s)}},_=(e,t)=>Math.floor(Math.sqrt(e/(t/4))),I=(e,t)=>{return(t=t||document.createElement("canvas")).width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t},f=e=>{let t=e.toDataURL();const a=document.createElement("div");a.className="fullsize-overlay";const i=document.createElement("div");i.className="image-container",i.style.backgroundImage="url("+t+")";let r=document.getElementsByTagName("body")[0];a.appendChild(i),r.appendChild(a),a.classList.add("visible"),a.addEventListener("click",()=>{a.remove()})},u=t=>{const a=(e=>e.utils.createView({name:"image-preview-overlay",tag:"div",ignoreRect:!0,create:({root:e,props:t})=>{!c&&document.querySelector("base")&&(s=s.replace(/url\(\#/g,"url("+window.location.href.replace(window.location.hash,"")+"#"),c=!0),l++,e.element.classList.add(`filepond--image-preview-overlay-${t.status}`),e.element.innerHTML=s.replace(/__UID__/g,l)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}}))(t),i=(t=>t.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,mixins:{apis:["crop","image"],styles:["translateY","scaleX","scaleY","opacity"],animations:{scaleX:e,scaleY:e,translateY:e,opacity:{type:"tween",duration:400}}},create:({root:e,props:a})=>{e.ref.clip=e.appendChildView(e.createChildView(n(t),{image:a.image,crop:a.crop}))},write:({root:e,props:t,shouldOptimize:a})=>{const{clip:i}=e.ref,{crop:r,image:o}=t;if(i.crop=r,i.opacity=a?0:1,a||e.rect.element.hidden)return;const n=o.height/o.width;let s=r.aspectRatio||n;const c=e.rect.inner.width,l=e.rect.inner.height;let h=e.query("GET_IMAGE_PREVIEW_HEIGHT");const d=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),g=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),p=e.query("GET_PANEL_ASPECT_RATIO"),E=e.query("GET_ALLOW_MULTIPLE");p&&!E&&(h=c*p,s=p);let m=null!==h?h:Math.max(d,Math.min(c*s,g)),_=m/s;_>c&&(m=(_=c)*s),m>l&&(m=l,_=l/s),i.width=_,i.height=m}}))(t),{createWorker:r}=t.utils,o=(e,t,a)=>new Promise(i=>{e.ref.imageData||(e.ref.imageData=a.getContext("2d").getImageData(0,0,a.width,a.height));const o=(e=>{let t;try{t=new ImageData(e.width,e.height)}catch(a){t=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return t.data.set(new Uint8ClampedArray(e.data)),t})(e.ref.imageData);if(!t||20!==t.length)return a.getContext("2d").putImageData(o,0,0),i();const n=r(d);n.post({imageData:o,colorMatrix:t},e=>{a.getContext("2d").putImageData(e,0,0),n.terminate(),i()},[o.data.buffer])}),g=({root:e,props:t,image:a})=>{const r=t.id,o=e.query("GET_ITEM",{id:r});if(!o)return;const n=o.getMetadata("crop")||{center:{x:.5,y:.5},flip:{horizontal:!1,vertical:!1},zoom:1,rotation:0,aspectRatio:null},s=e.appendChildView(e.createChildView(i,{image:a,crop:n,opacity:0,scaleX:1.15,scaleY:1.15,translateY:15}),e.childViews.length);e.ref.images.push(s),s.opacity=1,s.scaleX=1,s.scaleY=1,s.translateY=0,setTimeout(()=>{e.dispatch("DID_IMAGE_PREVIEW_SHOW",{id:r}),e.query("GET_ALLOW_FULL_SIZE_OVERLAY")&&(e=>{let t=e.closest(".filepond--image-preview-wrapper");t.style.cursor="zoom-in",t.addEventListener("click",()=>{f(e)})})(a)},250)},_=({root:e})=>{e.ref.overlayShadow.opacity=1,e.ref.overlayError.opacity=0,e.ref.overlaySuccess.opacity=0},u=({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlayError.opacity=1};return t.utils.createView({name:"image-preview-wrapper",create:({root:e})=>{e.ref.images=[],e.ref.imageData=null,e.ref.imageViewBin=[],e.ref.overlayShadow=e.appendChildView(e.createChildView(a,{opacity:0,status:"idle"})),e.ref.overlaySuccess=e.appendChildView(e.createChildView(a,{opacity:0,status:"success"})),e.ref.overlayError=e.appendChildView(e.createChildView(a,{opacity:0,status:"failure"}))},styles:["height"],apis:["height"],destroy:({root:e})=>{e.ref.images.forEach(e=>{e.image.width=1,e.image.height=1})},write:t.utils.createRoute({DID_IMAGE_PREVIEW_DRAW:({root:e})=>{const t=e.ref.images[e.ref.images.length-1];t.translateY=0,t.scaleX=1,t.scaleY=1,t.opacity=1},DID_IMAGE_PREVIEW_CONTAINER_CREATE:({root:e,props:t})=>{const{id:a}=t,i=e.query("GET_ITEM",a);i&&((e,t)=>{let a=new Image;a.onload=(()=>{const e=a.naturalWidth,i=a.naturalHeight;a=null,t(e,i)}),a.src=e})(URL.createObjectURL(i.file),(t,i)=>{e.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:a,width:t,height:i})})},DID_FINISH_CALCULATE_PREVIEWSIZE:({root:e,props:t})=>{const{id:a}=t,i=e.query("GET_ITEM",a);if(!i)return;const n=URL.createObjectURL(i.file),s=()=>{(e=>new Promise((t,a)=>{const i=new Image;i.crossOrigin="Anonymous",i.onload=(()=>{t(i)}),i.onerror=(e=>{a(e)}),i.src=e}))(n).then(c)},c=a=>{URL.revokeObjectURL(n);const r=(i.getMetadata("exif")||{}).orientation||-1;let{width:s,height:c}=a;r>=5&&r<=8&&([s,c]=[c,s]);const l=Math.max(1,.75*window.devicePixelRatio),h=e.query("GET_IMAGE_PREVIEW_ZOOM_FACTOR")*l,d=c/s,E=e.rect.element.width,_=e.rect.element.height;let I=E,f=I*d;d>1?f=(I=Math.min(s,E*h))*d:I=(f=Math.min(c,_*h))/d;const u=p(a,I,f,r),w=()=>{const r=e.query("GET_IMAGE_PREVIEW_CALCULATE_AVERAGE_IMAGE_COLOR")?m(data):null;i.setMetadata("color",r,!0),"close"in a&&a.close(),e.ref.overlayShadow.opacity=1,g({root:e,props:t,image:u})},y=i.getMetadata("filter");y?o(e,y,u).then(w):w()};if((e=>"createImageBitmap"in window&&E(e))(i.file)){const e=r(h);e.post({file:i.file},t=>{e.terminate(),t?c(t):s()})}else s()},DID_UPDATE_ITEM_METADATA:({root:e,props:t,action:a})=>{if(!/crop|filter/.test(a.change.key))return;if(!e.ref.images.length)return;const i=e.query("GET_ITEM",{id:t.id});if(i)if(/filter/.test(a.change.key)){const t=e.ref.images[e.ref.images.length-1];o(e,a.change.value,t.image)}else if(/crop/.test(a.change.key)){const a=i.getMetadata("crop"),r=e.ref.images[e.ref.images.length-1];if(Math.abs(a.aspectRatio-r.crop.aspectRatio)>1e-5){const a=(({root:e})=>{const t=e.ref.images.shift();return t.opacity=0,t.translateY=-15,e.ref.imageViewBin.push(t),t})({root:e});g({root:e,props:t,image:I(a.image)})}else(({root:e,props:t})=>{const a=e.query("GET_ITEM",{id:t.id});a&&(e.ref.images[e.ref.images.length-1].crop=a.getMetadata("crop"))})({root:e,props:t})}},DID_THROW_ITEM_LOAD_ERROR:u,DID_THROW_ITEM_PROCESSING_ERROR:u,DID_THROW_ITEM_INVALID:u,DID_COMPLETE_ITEM_PROCESSING:({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlaySuccess.opacity=1},DID_START_ITEM_PROCESSING:_,DID_REVERT_ITEM_PROCESSING:_},({root:e})=>{const t=e.ref.imageViewBin.filter(e=>0===e.opacity);e.ref.imageViewBin=e.ref.imageViewBin.filter(e=>e.opacity>0),t.forEach(t=>((e,t)=>{e.removeChildView(t),t.image.width=1,t.image.height=1,t._destroy()})(e,t)),t.length=0})})},w=e=>{const{addFilter:t,utils:a}=e,{Type:i,createRoute:r,isFile:o}=a,n=u(e);return t("CREATE_VIEW",e=>{const{is:t,view:a,query:i}=e;if(!t("file")||!i("GET_ALLOW_IMAGE_PREVIEW"))return;const s=({root:e})=>{e.ref.shouldRescale=!0};a.registerWriter(r({DID_RESIZE_ROOT:s,DID_STOP_RESIZE:s,DID_LOAD_ITEM:({root:e,props:t})=>{const{id:r}=t,s=i("GET_ITEM",r);if(!s||!o(s.file)||s.archived)return;const c=s.file;if(!(e=>/^image/.test(e.type))(c))return;const l="createImageBitmap"in(window||{}),h=i("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");if(!l&&h&&c.size>h)return;e.ref.imagePreview=a.appendChildView(a.createChildView(n,{id:r}));const d=e.query("GET_IMAGE_PREVIEW_HEIGHT");d&&e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:s.id,height:d});const g=!l&&c.size>i("GET_IMAGE_PREVIEW_MAX_INSTANT_PREVIEW_FILE_SIZE");e.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:r},g)},DID_IMAGE_PREVIEW_CALCULATE_SIZE:({root:e,action:t})=>{e.ref.imageWidth=t.width,e.ref.imageHeight=t.height,e.ref.shouldRescale=!0,e.ref.shouldDrawPreview=!0,e.dispatch("KICK")},DID_UPDATE_ITEM_METADATA:({root:e,action:t})=>{"crop"===t.change.key&&(e.ref.shouldRescale=!0)}},({root:e,props:t})=>{e.rect.element.hidden||(e.ref.shouldRescale&&(((e,t)=>{if(!e.ref.imagePreview)return;let{id:a}=t;const i=e.query("GET_ITEM",{id:a});if(!i)return;const r=e.query("GET_PANEL_ASPECT_RATIO"),o=e.query("GET_ITEM_PANEL_ASPECT_RATIO"),n=e.query("GET_IMAGE_PREVIEW_HEIGHT");if(r||o||n)return;let{imageWidth:s,imageHeight:c}=e.ref;if(!s||!c)return;const l=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),h=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),d=(i.getMetadata("exif")||{}).orientation||-1;if(d>=5&&d<=8&&([s,c]=[c,s]),!E(i.file)||e.query("GET_IMAGE_PREVIEW_UPSCALE")){const e=2048/s;s*=e,c*=e}const g=c/s,p=(i.getMetadata("crop")||{}).aspectRatio||g;let m=Math.max(l,Math.min(c,h));const _=e.rect.element.width,I=Math.min(_*p,m);e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:i.id,height:I})})(e,t),e.ref.shouldRescale=!1),e.ref.shouldDrawPreview&&(requestAnimationFrame(()=>{e.dispatch("DID_FINISH_CALCULATE_PREVIEWSIZE",{id:t.id})}),e.ref.shouldDrawPreview=!1))}))}),{options:{allowImagePreview:[!0,i.BOOLEAN],allowFullSizeOverlay:[!1,i.BOOLEAN],imagePreviewHeight:[null,i.INT],imagePreviewMinHeight:[44,i.INT],imagePreviewMaxHeight:[256,i.INT],imagePreviewMaxFileSize:[null,i.INT],imagePreviewZoomFactor:[2,i.INT],imagePreviewUpscale:[!1,i.BOOLEAN],imagePreviewMaxInstantPreviewFileSize:[1e6,i.INT],imagePreviewTransparencyIndicator:[null,i.STRING],imagePreviewCalculateAverageImageColor:[!1,i.BOOLEAN]}}};"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:w}));export default w;
